<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layer IV - Laboratory of Time</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: 'Inter', sans-serif;
      background: 
        linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(30, 30, 50, 0.9) 30%, rgba(0, 0, 0, 0.95) 70%, rgba(20, 40, 60, 0.8) 100%),
        radial-gradient(ellipse at 30% 20%, rgba(100, 200, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(255, 150, 50, 0.08) 0%, transparent 60%),
        linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
        url('../assets/steinsgate/steinsgate.jpg');
      background-size: 
        100% 100%, 
        150% 150%, 
        120% 120%, 
        cover, 
        120% 120%;
      background-position: 
        center, 
        left top, 
        right bottom, 
        center, 
        center;
      background-attachment: fixed;
      min-height: 100vh;
      color: #ffffff;
      position: relative;
      overflow-x: hidden;
      animation: 
        bgShift 25s ease-in-out infinite,
        labPulse 15s ease-in-out infinite;
    }

    @keyframes bgShift {
      0%, 100% { 
        background-size: 
          100% 100%, 
          145% 145%, 
          115% 115%, 
          cover, 
          115% 115%;
        filter: brightness(0.8) contrast(1.2) saturate(1.1) hue-rotate(0deg);
      }
      50% { 
        background-size: 
          100% 100%, 
          160% 160%, 
          130% 130%, 
          cover, 
          125% 125%;
        filter: brightness(0.9) contrast(1.4) saturate(1.3) hue-rotate(5deg);
      }
    }

    @keyframes labPulse {
      0%, 100% { 
        background-position: 
          center, 
          left top, 
          right bottom, 
          center, 
          center top; 
      }
      50% { 
        background-position: 
          center, 
          right top, 
          left bottom, 
          center, 
          center bottom; 
      }
    }

    /* Steins;Gate laboratory overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: 
        radial-gradient(circle at 20% 30%, rgba(100, 200, 255, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255, 150, 50, 0.1) 0%, transparent 60%),
        linear-gradient(45deg, transparent 0%, rgba(50, 150, 255, 0.05) 25%, transparent 50%, rgba(255, 200, 100, 0.03) 75%, transparent 100%),
        conic-gradient(from 0deg at 50% 50%, transparent, rgba(100, 200, 255, 0.02) 90deg, transparent 180deg, rgba(255, 150, 50, 0.02) 270deg, transparent);
      z-index: -1;
      animation: 
        labAtmosphere 20s ease-in-out infinite,
        timeDistortion 12s linear infinite;
    }

    @keyframes labAtmosphere {
      0%, 100% { 
        opacity: 0.8; 
        transform: scale(1) rotate(0deg);
      }
      33% { 
        opacity: 1; 
        transform: scale(1.02) rotate(0.5deg);
      }
      66% { 
        opacity: 0.9; 
        transform: scale(1.01) rotate(-0.3deg);
      }
    }

    @keyframes timeDistortion {
      0% { filter: hue-rotate(0deg) brightness(1); }
      25% { filter: hue-rotate(3deg) brightness(1.1); }
      50% { filter: hue-rotate(-2deg) brightness(0.95); }
      75% { filter: hue-rotate(4deg) brightness(1.05); }
      100% { filter: hue-rotate(0deg) brightness(1); }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 10;
    }

    /* Back button in Steins;Gate style */
    .back-link {
      position: fixed;
      top: 2rem;
      left: 2rem;
      background: linear-gradient(135deg, #1e90ff 0%, #0066cc 50%, #1e90ff 100%);
      border: 3px solid #00ccff;
      color: #ffffff;
      padding: 0.8rem 1.5rem;
      text-decoration: none;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 8px;
      box-shadow: 
        0 0 20px rgba(30, 144, 255, 0.6),
        inset 0 0 10px rgba(255, 255, 255, 0.1);
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
    }

    .back-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .back-link:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 
        0 10px 30px rgba(30, 144, 255, 0.8),
        inset 0 0 20px rgba(255, 255, 255, 0.2),
        0 0 40px rgba(0, 204, 255, 0.6);
      background: linear-gradient(135deg, #00ccff 0%, #1e90ff 50%, #00ccff 100%);
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }

    .back-link:hover::before {
      left: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .title {
      font-family: 'Orbitron', monospace;
      font-size: 4rem;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 
        0 0 10px #1e90ff,
        0 0 20px #1e90ff,
        0 0 30px #00ccff,
        0 0 40px #00ccff,
        2px 2px 0px #000000,
        4px 4px 0px rgba(0, 0, 0, 0.7);
      margin-bottom: 1rem;
      animation: 
        titleGlow 8s ease-in-out infinite,
        titleFloat 10s ease-in-out infinite,
        timeGlitch 15s ease-in-out infinite;
      letter-spacing: 4px;
      transform: perspective(800px) rotateX(10deg);
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #00ccff 30%, #1e90ff 60%, #ffffff 100%);
      background-clip: text;
      -webkit-background-clip: text;
      background-size: 400% 400%;
    }

    .title::before {
      content: 'LAYER IV';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      color: transparent;
      background: linear-gradient(45deg, #1e90ff, #00ccff, #ffffff, #87ceeb, #1e90ff);
      background-clip: text;
      -webkit-background-clip: text;
      background-size: 500% 500%;
      animation: titleShimmer 4s linear infinite;
      z-index: -1;
      filter: blur(1px);
    }

    @keyframes titleGlow {
      0%, 100% { 
        text-shadow: 
          0 0 10px #1e90ff,
          0 0 20px #1e90ff,
          0 0 30px #00ccff,
          0 0 40px #00ccff,
          2px 2px 0px #000000,
          4px 4px 0px rgba(0, 0, 0, 0.7);
      }
      50% { 
        text-shadow: 
          0 0 20px #1e90ff,
          0 0 40px #1e90ff,
          0 0 60px #00ccff,
          0 0 80px #00ccff,
          0 0 100px #87ceeb,
          2px 2px 0px #000000,
          4px 4px 0px rgba(0, 0, 0, 0.9);
      }
    }

    @keyframes titleFloat {
      0%, 100% { transform: perspective(800px) rotateX(10deg) translateY(0px); }
      50% { transform: perspective(800px) rotateX(10deg) translateY(-6px); }
    }

    @keyframes timeGlitch {
      0%, 95%, 100% { transform: perspective(800px) rotateX(10deg); }
      96% { transform: perspective(800px) rotateX(10deg) skewX(2deg); }
      97% { transform: perspective(800px) rotateX(10deg) skewX(-1deg); }
      98% { transform: perspective(800px) rotateX(10deg) skewX(0.5deg); }
      99% { transform: perspective(800px) rotateX(10deg); }
    }

    @keyframes titleShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    .subtitle {
      font-family: 'Orbitron', monospace;
      font-size: 2.2rem;
      color: #00ccff;
      text-shadow: 
        0 0 15px #00ccff,
        0 0 25px #1e90ff,
        2px 2px 0px #000000;
      margin-bottom: 0.5rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      animation: 
        subtitlePulse 6s ease-in-out infinite,
        subtitleGlow 8s ease-in-out infinite;
    }

    @keyframes subtitlePulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.9;
      }
      50% { 
        transform: scale(1.03);
        opacity: 1;
      }
    }

    @keyframes subtitleGlow {
      0%, 100% { 
        color: #00ccff;
        text-shadow: 
          0 0 15px #00ccff,
          0 0 25px #1e90ff,
          2px 2px 0px #000000;
      }
      50% { 
        color: #1e90ff;
        text-shadow: 
          0 0 25px #00ccff,
          0 0 35px #1e90ff,
          0 0 45px #87ceeb,
          2px 2px 0px #000000;
      }
    }

    .location {
      font-size: 1.3rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 3rem;
      text-shadow: 
        1px 1px 2px rgba(0, 0, 0, 0.8),
        0 0 8px rgba(30, 144, 255, 0.4);
      font-style: italic;
      animation: locationFloat 7s ease-in-out infinite;
      letter-spacing: 1px;
    }

    @keyframes locationFloat {
      0%, 100% { 
        transform: translateY(0px);
        text-shadow: 
          1px 1px 2px rgba(0, 0, 0, 0.8),
          0 0 8px rgba(30, 144, 255, 0.4);
      }
      50% { 
        transform: translateY(-3px);
        text-shadow: 
          1px 1px 2px rgba(0, 0, 0, 0.9),
          0 0 12px rgba(30, 144, 255, 0.6),
          0 0 20px rgba(0, 204, 255, 0.3);
      }
    }

    /* Time Laboratory Container */
    .lab-container {
      background: 
        linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(30, 50, 80, 0.8) 30%, rgba(0, 0, 0, 0.95) 70%, rgba(20, 40, 60, 0.85) 100%),
        radial-gradient(ellipse at 30% 40%, rgba(30, 144, 255, 0.1) 0%, transparent 60%),
        radial-gradient(ellipse at 70% 60%, rgba(0, 204, 255, 0.08) 0%, transparent 60%);
      border: 3px solid #00ccff;
      border-radius: 15px;
      padding: 3rem;
      margin-bottom: 2rem;
      box-shadow: 
        0 0 40px rgba(30, 144, 255, 0.6),
        inset 0 0 30px rgba(30, 144, 255, 0.1),
        0 0 80px rgba(0, 204, 255, 0.3),
        0 15px 40px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 1000px;
      animation: 
        labFloat 10s ease-in-out infinite,
        labPulse 8s ease-in-out infinite;
      backdrop-filter: blur(10px) saturate(1.2);
    }

    @keyframes labFloat {
      0%, 100% { 
        transform: translateY(0px) scale(1);
      }
      50% { 
        transform: translateY(-8px) scale(1.01);
      }
    }

    @keyframes labPulse {
      0%, 100% { 
        box-shadow: 
          0 0 40px rgba(30, 144, 255, 0.6),
          inset 0 0 30px rgba(30, 144, 255, 0.1),
          0 0 80px rgba(0, 204, 255, 0.3),
          0 15px 40px rgba(0, 0, 0, 0.5);
      }
      50% { 
        box-shadow: 
          0 0 60px rgba(30, 144, 255, 0.8),
          inset 0 0 40px rgba(30, 144, 255, 0.2),
          0 0 120px rgba(0, 204, 255, 0.5),
          0 20px 50px rgba(0, 0, 0, 0.6);
      }
    }

    .lab-title {
      font-family: 'Orbitron', monospace;
      font-size: 2.5rem;
      color: #00ccff;
      margin-bottom: 2rem;
      text-align: center;
      text-shadow: 
        0 0 15px #00ccff,
        2px 2px 4px rgba(0, 0, 0, 0.9);
      letter-spacing: 2px;
      text-transform: uppercase;
      animation: labTitleGlow 6s ease-in-out infinite;
    }

    @keyframes labTitleGlow {
      0%, 100% { 
        transform: scale(1);
        filter: brightness(1);
      }
      50% { 
        transform: scale(1.02);
        filter: brightness(1.2);
      }
    }

    /* Time Machine Interface */
    .time-machine {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .microwave-section {
      text-align: center;
    }

    .microwave-container {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }

    .microwave-img {
      width: 200px;
      height: auto;
      border-radius: 10px;
      box-shadow: 
        0 0 20px rgba(30, 144, 255, 0.4),
        0 8px 25px rgba(0, 0, 0, 0.6);
      transition: all 0.3s ease;
      animation: microwaveHum 4s ease-in-out infinite;
    }

    @keyframes microwaveHum {
      0%, 100% { 
        transform: scale(1);
        filter: brightness(1);
      }
      50% { 
        transform: scale(1.02);
        filter: brightness(1.1);
      }
    }

    .microwave-img.active {
      box-shadow: 
        0 0 40px rgba(255, 150, 50, 0.8),
        0 8px 25px rgba(0, 0, 0, 0.6);
      animation: microwaveActive 2s ease-in-out infinite;
    }

    @keyframes microwaveActive {
      0%, 100% { 
        transform: scale(1);
        filter: brightness(1) hue-rotate(0deg);
      }
      50% { 
        transform: scale(1.05);
        filter: brightness(1.3) hue-rotate(10deg);
      }
    }

    .banana-section {
      text-align: center;
    }

    .banana-img {
      width: 120px;
      height: auto;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 10px;
      margin: 0.5rem;
      animation: bananaFloat 6s ease-in-out infinite;
    }

    @keyframes bananaFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-5px) rotate(2deg); }
    }

    .banana-img:hover {
      transform: scale(1.1) rotate(5deg);
      filter: brightness(1.2);
      box-shadow: 0 0 15px rgba(255, 255, 0, 0.6);
    }

    .banana-img.selected {
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
      border: 3px solid #00ff00;
    }

    /* Time Travel Controls */
    .time-controls {
      background: 
        linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 40, 80, 0.7) 50%, rgba(0, 0, 0, 0.8) 100%);
      border: 2px solid #1e90ff;
      border-radius: 12px;
      padding: 2rem;
      margin-top: 2rem;
      position: relative;
    }

    .time-controls::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #1e90ff, #00ccff, #87ceeb, #1e90ff);
      background-size: 400% 400%;
      border-radius: 12px;
      z-index: -1;
      animation: timeBorder 3s linear infinite;
    }

    @keyframes timeBorder {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .time-display {
      font-family: 'Orbitron', monospace;
      font-size: 1.8rem;
      color: #00ccff;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 10px #00ccff;
      animation: timeFlicker 3s ease-in-out infinite;
    }

    @keyframes timeFlicker {
      0%, 90%, 100% { opacity: 1; }
      93%, 97% { opacity: 0.7; }
    }

    .divergence-meter {
      font-family: 'Orbitron', monospace;
      font-size: 2.5rem;
      color: #ff6600;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 
        0 0 15px #ff6600,
        0 0 25px #ff6600;
      letter-spacing: 3px;
      animation: divergenceGlow 4s ease-in-out infinite;
    }

    @keyframes divergenceGlow {
      0%, 100% { 
        filter: brightness(1);
        transform: scale(1);
      }
      50% { 
        filter: brightness(1.3);
        transform: scale(1.02);
      }
    }

    .control-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .time-btn {
      background: linear-gradient(135deg, #1e90ff 0%, #0066cc 50%, #1e90ff 100%);
      border: 2px solid #00ccff;
      color: #ffffff;
      padding: 1rem 2rem;
      font-family: 'Orbitron', monospace;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 
        0 0 15px rgba(30, 144, 255, 0.4),
        inset 0 0 10px rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .time-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .time-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 8px 25px rgba(30, 144, 255, 0.6),
        inset 0 0 20px rgba(255, 255, 255, 0.2);
      background: linear-gradient(135deg, #00ccff 0%, #1e90ff 50%, #00ccff 100%);
    }

    .time-btn:hover::before {
      left: 100%;
    }

    .time-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666666, #444444) !important;
      border-color: #666666 !important;
    }

    /* Experiment Log */
    .experiment-log {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #00ccff;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
      min-height: 150px;
      font-family: 'JetBrains Mono', monospace;
      color: #00ccff;
      overflow-y: auto;
      max-height: 200px;
    }

    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.3rem 0;
      border-bottom: 1px solid rgba(0, 204, 255, 0.2);
      animation: logAppear 0.5s ease-in;
    }

    @keyframes logAppear {
      0% {
        opacity: 0;
        transform: translateX(-20px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .log-entry.success {
      color: #00ff00;
      text-shadow: 0 0 5px #00ff00;
    }

    .log-entry.warning {
      color: #ffaa00;
      text-shadow: 0 0 5px #ffaa00;
    }

    .log-entry.error {
      color: #ff0000;
      text-shadow: 0 0 5px #ff0000;
    }

    .hidden-fragment {
      color: transparent;
      background: transparent;
      font-size: 0.8rem;
      font-family: 'JetBrains Mono', monospace;
      font-weight: bold;
      user-select: none;
      cursor: default;
      transition: all 0.3s ease;
    }

    .hidden-fragment:hover {
      color: #00ccff;
      background: rgba(0, 0, 0, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      text-shadow: 0 0 10px rgba(0, 204, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 204, 255, 0.3);
    }

    /* Victory Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      background: 
        linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 50, 80, 0.9) 50%, rgba(0, 0, 0, 0.95) 100%);
      margin: 8% auto;
      padding: 3rem;
      border: 3px solid #00ccff;
      border-radius: 15px;
      width: 85%;
      max-width: 600px;
      text-align: center;
      box-shadow: 
        0 0 60px rgba(30, 144, 255, 0.8),
        inset 0 0 40px rgba(30, 144, 255, 0.1);
      position: relative;
    }

    .modal h3 {
      color: #00ccff;
      margin-bottom: 2rem;
      font-family: 'Orbitron', monospace;
      font-size: 2.2rem;
      text-shadow: 
        0 0 20px #00ccff,
        2px 2px 0px #000000;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .modal p {
      color: #ffffff;
      line-height: 2;
      margin-bottom: 1.5rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      font-size: 1.1rem;
    }

    .close-btn {
      background: linear-gradient(135deg, #1e90ff 0%, #0066cc 50%, #1e90ff 100%);
      border: 2px solid #00ccff;
      color: #ffffff;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 2rem;
      font-family: 'Orbitron', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: linear-gradient(135deg, #00ccff 0%, #1e90ff 50%, #00ccff 100%);
      box-shadow: 0 8px 25px rgba(30, 144, 255, 0.5);
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }

    /* Digital effects */
    .digital-static {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
      opacity: 0.1;
      background: 
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2px,
          rgba(30, 144, 255, 0.02) 2px,
          rgba(30, 144, 255, 0.02) 4px
        );
      animation: staticMove 8s linear infinite;
    }

    @keyframes staticMove {
      0% { transform: translateX(0px); }
      100% { transform: translateX(50px); }
    }

    /* Multi-Phase Experiment System CSS */
    .experiment-status {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(0, 204, 255, 0.1), rgba(100, 150, 255, 0.05));
      border: 2px solid rgba(0, 204, 255, 0.3);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .phase-indicator {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .phase-title {
      color: #00ccff;
      font-family: 'Orbitron', monospace;
      font-size: 1.2rem;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
    }

    .phase-progress {
      width: 200px;
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(0, 204, 255, 0.3);
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00ccff, #1e90ff);
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
    }

    .stability-meter {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }

    .stability-label {
      color: #ffffff;
      font-size: 0.9rem;
      font-family: 'Orbitron', monospace;
    }

    .stability-bar {
      width: 120px;
      height: 12px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stability-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff00);
      transition: width 0.3s ease;
    }

    .stability-value {
      color: #00ff00;
      font-size: 0.8rem;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
    }

    /* Calibration Panel */
    .calibration-panel {
      background: linear-gradient(135deg, rgba(255, 170, 0, 0.1), rgba(255, 100, 0, 0.05));
      border: 2px solid rgba(255, 170, 0, 0.3);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .panel-title {
      color: #ffaa00;
      font-family: 'Orbitron', monospace;
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 1.5rem;
      text-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
    }

    .calibration-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .calibration-control {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .calibration-control label {
      color: #ffffff;
      font-family: 'Orbitron', monospace;
      font-size: 0.9rem;
      font-weight: bold;
    }

    .calibration-control input[type="range"] {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      outline: none;
      border: 1px solid rgba(255, 170, 0, 0.3);
    }

    .calibration-control input[type="range"]::-webkit-slider-thumb {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #ffaa00, #ff6600);
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #ffffff;
      box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
    }

    .calibration-control input[type="text"] {
      padding: 0.7rem;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 170, 0, 0.3);
      border-radius: 8px;
      color: #ffffff;
      font-family: 'Orbitron', monospace;
      font-size: 1rem;
    }

    .calibration-control input[type="text"]:focus {
      border-color: #ffaa00;
      box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
      outline: none;
    }

    .target-zone {
      color: #00ff00;
      font-size: 0.8rem;
      font-family: 'JetBrains Mono', monospace;
      font-style: italic;
      margin-top: 0.3rem;
      position: relative;
      overflow: hidden;
      animation: 
        targetGlitch 4s infinite,
        targetScramble 2s infinite,
        targetFlicker 0.5s infinite;
      text-shadow: 
        0 0 5px #00ff00,
        2px 0 #ff0000,
        -2px 0 #0000ff;
      filter: blur(0.3px) contrast(1.5);
    }

    @keyframes targetGlitch {
      0%, 90%, 100% { 
        transform: translateX(0px) skewX(0deg);
        filter: blur(0.3px) contrast(1.5) hue-rotate(0deg);
      }
      92% { 
        transform: translateX(2px) skewX(2deg);
        filter: blur(0.8px) contrast(2) hue-rotate(90deg);
      }
      94% { 
        transform: translateX(-1px) skewX(-1deg);
        filter: blur(0.5px) contrast(1.8) hue-rotate(180deg);
      }
      96% { 
        transform: translateX(1px) skewX(1deg);
        filter: blur(0.4px) contrast(2.2) hue-rotate(270deg);
      }
    }

    @keyframes targetScramble {
      0%, 80%, 100% { 
        opacity: 1;
        letter-spacing: 0;
      }
      82% { 
        opacity: 0.3;
        letter-spacing: 3px;
        text-shadow: 
          0 0 10px #00ff00,
          4px 0 #ff0000,
          -4px 0 #0000ff,
          0 4px #ffff00;
      }
      84% { 
        opacity: 0.7;
        letter-spacing: -1px;
        text-shadow: 
          0 0 15px #ff00ff,
          3px 0 #00ffff,
          -3px 0 #ffff00;
      }
      86% { 
        opacity: 0.4;
        letter-spacing: 2px;
        text-shadow: 
          0 0 8px #ffffff,
          2px 2px #ff0000,
          -2px -2px #0000ff;
      }
    }

    @keyframes targetFlicker {
      0%, 96%, 100% { opacity: 1; }
      97%, 99% { opacity: 0.1; }
      98% { opacity: 0.6; }
    }

    .target-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        rgba(0, 255, 255, 0.2),
        rgba(255, 0, 255, 0.1),
        transparent
      );
      animation: targetScan 3s infinite linear;
    }

    @keyframes targetScan {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .target-zone::after {
      content: attr(data-scrambled);
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      color: #ff0000;
      opacity: 0;
      animation: scrambledText 4s infinite;
      text-shadow: 0 0 10px #ff0000;
      filter: blur(1px);
    }

    @keyframes scrambledText {
      0%, 85%, 100% { opacity: 0; }
      87%, 89%, 91% { opacity: 0.8; }
      88%, 90% { opacity: 0.2; }
    }

    /* Cipher display for targets */
    .cipher-hint {
      color: #666666;
      font-size: 0.7rem;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 0.2rem;
      text-align: center;
      opacity: 0.5;
      animation: cipherPulse 3s infinite;
    }

    @keyframes cipherPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.7; }
    }

    /* Hidden morse code pattern */
    .morse-pattern {
      position: absolute;
      top: -20px;
      right: 0;
      font-size: 0.6rem;
      color: rgba(0, 255, 0, 0.2);
      font-family: 'JetBrains Mono', monospace;
      animation: morseFlash 5s infinite;
    }

    @keyframes morseFlash {
      0%, 90%, 100% { opacity: 0; }
      91%, 94%, 97% { opacity: 0.8; }
      92%, 95%, 98% { opacity: 0.1; }
    }

    /* Additional complexity indicators */
    .complexity-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 8px;
      height: 8px;
      background: #ff6600;
      border-radius: 50%;
      animation: complexityBlink 2s infinite;
    }

    @keyframes complexityBlink {
      0%, 70%, 100% { opacity: 0; }
      71%, 85% { opacity: 1; }
    }

    /* Enhanced calibration panel */
    .calibration-panel {
      background: 
        linear-gradient(135deg, rgba(255, 170, 0, 0.1), rgba(255, 100, 0, 0.05)),
        repeating-linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.01) 0px,
          rgba(255, 255, 255, 0.01) 1px,
          transparent 1px,
          transparent 20px
        );
      border: 2px solid rgba(255, 170, 0, 0.3);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .calibration-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(255, 0, 0, 0.03), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(0, 255, 0, 0.03), transparent 50%);
      animation: panelDistortion 8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes panelDistortion {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        opacity: 0.5;
      }
      50% { 
        transform: scale(1.002) rotate(0.1deg);
        opacity: 0.8;
      }
    }

    .calibration-status {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .status-indicator {
      padding: 0.5rem;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 0.8rem;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .status-indicator.success {
      color: #00ff00;
      border-color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }

    /* Experiment Panel */
    .experiment-panel {
      background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(50, 255, 50, 0.05));
      border: 2px solid rgba(0, 255, 0, 0.3);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .experiment-timer {
      text-align: center;
      margin-bottom: 1.5rem;
      font-family: 'Orbitron', monospace;
      color: #ffffff;
      font-size: 1.2rem;
    }

    .experiment-timer span {
      color: #00ff00;
      font-size: 2rem;
      text-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
    }

    .control-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .emergency-stop {
      background: linear-gradient(135deg, #ff4444, #cc0000) !important;
      border-color: #ff4444 !important;
      animation: emergencyPulse 1s infinite alternate;
    }

    @keyframes emergencyPulse {
      0% { box-shadow: 0 0 5px rgba(255, 68, 68, 0.5); }
      100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.8); }
    }

    .reaction-monitor {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 0, 0.2);
    }

    .monitor-reading {
      text-align: center;
      font-family: 'Orbitron', monospace;
      color: #ffffff;
      font-size: 0.9rem;
    }

    .monitor-reading span {
      color: #00ff00;
      font-weight: bold;
      display: block;
      font-size: 1.1rem;
      margin-top: 0.3rem;
    }

    /* D-Mail Panel */
    .dmail-panel {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.1), rgba(200, 0, 255, 0.05));
      border: 2px solid rgba(255, 0, 255, 0.3);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .dmail-setup {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .dmail-setup label {
      color: #ffffff;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .dmail-setup input, .dmail-setup textarea {
      padding: 0.7rem;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 0, 255, 0.3);
      border-radius: 8px;
      color: #ffffff;
      font-family: 'JetBrains Mono', monospace;
      resize: none;
    }

    .dmail-setup input:focus, .dmail-setup textarea:focus {
      border-color: #ff00ff;
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
      outline: none;
    }

    .char-counter {
      color: #ffaa00;
      font-size: 0.8rem;
      font-family: 'Orbitron', monospace;
      text-align: right;
    }

    .sern-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.7rem;
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 8px;
    }

    .sern-indicator {
      color: #ff4444;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
    }

    .sern-status.hacked {
      background: rgba(0, 255, 0, 0.1);
      border-color: rgba(0, 255, 0, 0.3);
    }

    .sern-status.hacked .sern-indicator {
      color: #00ff00;
    }

    /* Time Leap Panel */
    .timeleap-panel {
      background: linear-gradient(135deg, rgba(255, 255, 0, 0.1), rgba(255, 200, 0, 0.05));
      border: 2px solid rgba(255, 255, 0, 0.3);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .memory-compression, .leap-target, .leap-precision {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 0, 0.2);
    }

    .compression-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 0.5rem 0;
    }

    .compression-bar {
      flex: 1;
      height: 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 0, 0.3);
    }

    .compression-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffff00, #ffaa00);
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
    }

    .leap-risk {
      color: #ffaa00;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      margin-top: 0.5rem;
    }

    .precision-warning {
      color: #ff4444;
      font-size: 0.8rem;
      font-style: italic;
      margin-top: 0.3rem;
    }

    .time-btn.small {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    /* General improvements */
    .time-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666666, #444444) !important;
      border-color: #666666 !important;
    }

    .time-btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 204, 255, 0.3);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .title { font-size: 2.5rem; }
      .subtitle { font-size: 1.5rem; }
      .time-machine { 
        grid-template-columns: 1fr; 
        gap: 1.5rem;
      }
      .lab-container { 
        padding: 2rem; 
        margin: 1rem;
      }
      .control-buttons { 
        flex-direction: column; 
        align-items: center;
      }
      .microwave-img { width: 150px; }
      .banana-img { width: 80px; }
      .back-link {
        top: 1rem;
        left: 1rem;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
    }

    /* Ultra-hard proximity animations */
    @keyframes proximityPulse {
      0%, 100% { 
        box-shadow: 0 0 5px rgba(255, 170, 0, 0.5);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 15px rgba(255, 170, 0, 0.8);
        transform: scale(1.02);
      }
    }

    /* Enhanced glitch system for extreme difficulty */
    .ultra-glitch {
      position: relative;
      animation: 
        ultraGlitch 0.3s infinite,
        dataCorruption 2s infinite,
        quantumFlux 4s infinite;
    }

    @keyframes ultraGlitch {
      0% { 
        clip-path: inset(40% 0 61% 0);
      }
      20% { 
        clip-path: inset(92% 0 1% 0);
      }
      40% { 
        clip-path: inset(43% 0 1% 0);
      }
      60% { 
        clip-path: inset(25% 0 58% 0);
      }
      80% { 
        clip-path: inset(54% 0 7% 0);
      }
      100% { 
        clip-path: inset(58% 0 43% 0);
      }
    }

    @keyframes dataCorruption {
      0%, 90%, 100% { 
        transform: translate(0);
        filter: hue-rotate(0deg);
      }
      91% { 
        transform: translate(-2px, 2px);
        filter: hue-rotate(90deg);
      }
      92% { 
        transform: translate(2px, -2px);
        filter: hue-rotate(180deg);
      }
      93% { 
        transform: translate(-1px, -1px);
        filter: hue-rotate(270deg);
      }
    }

    @keyframes quantumFlux {
      0%, 100% { 
        text-shadow: 
          0 0 5px #00ff00,
          2px 0 #ff0000,
          -2px 0 #0000ff;
      }
      25% { 
        text-shadow: 
          0 0 8px #ff00ff,
          3px 0 #00ffff,
          -3px 0 #ffff00;
      }
      50% { 
        text-shadow: 
          0 0 12px #ffffff,
          4px 0 #ff6600,
          -4px 0 #6600ff;
      }
      75% { 
        text-shadow: 
          0 0 6px #00ff66,
          2px 0 #ff0066,
          -2px 0 #6600ff;
      }
    }

    /* Hidden message reveals */
    .hidden-cipher {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: rgba(255, 255, 255, 0.1);
      font-family: 'JetBrains Mono', monospace;
      opacity: 0;
      animation: cipherReveal 8s infinite;
      pointer-events: none;
      white-space: nowrap;
    }

    @keyframes cipherReveal {
      0%, 85%, 100% { opacity: 0; }
      87%, 91% { opacity: 0.7; }
      89% { opacity: 0.2; }
    }

    /* Musical synchronization effects */
    .music-sync {
      animation: musicPulse 2.4s infinite ease-in-out;
    }

    @keyframes musicPulse {
      0%, 100% { 
        filter: brightness(1) saturate(1);
        transform: scale(1);
      }
      50% { 
        filter: brightness(1.1) saturate(1.2);
        transform: scale(1.001);
      }
    }

    /* Fibonacci sequence visual hint */
    .fibonacci-hint {
      position: relative;
    }

    .fibonacci-hint::before {
      content: "1 1 2 3 5 8 13 21 34 55 89 144 233...";
      position: absolute;
      top: -25px;
      left: 0;
      font-size: 0.5rem;
      color: rgba(255, 215, 0, 0.2);
      font-family: 'JetBrains Mono', monospace;
      animation: fibonacciFlash 10s infinite;
    }

    @keyframes fibonacciFlash {
      0%, 92%, 100% { opacity: 0; }
      93%, 97% { opacity: 0.6; }
      95% { opacity: 0.1; }
    }

    /* Prime number hint */
    .prime-hint {
      position: relative;
    }

    .prime-hint::before {
      content: "2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 53 59 61 67 71 73...";
      position: absolute;
      top: -25px;
      left: 0;
      font-size: 0.5rem;
      color: rgba(0, 255, 127, 0.2);
      font-family: 'JetBrains Mono', monospace;
      animation: primeFlash 12s infinite;
    }

    @keyframes primeFlash {
      0%, 90%, 100% { opacity: 0; }
      91%, 95% { opacity: 0.6; }
      93% { opacity: 0.1; }
    }

    /* Hex conversion hint */
    .hex-hint {
      position: relative;
    }

    .hex-hint::before {
      content: "0x998 = 2456₁₀ = 4630₈";
      position: absolute;
      top: -25px;
      left: 0;
      font-size: 0.5rem;
      color: rgba(255, 20, 147, 0.2);
      font-family: 'JetBrains Mono', monospace;
      animation: hexFlash 14s infinite;
    }

    @keyframes hexFlash {
      0%, 88%, 100% { opacity: 0; }
      89%, 93% { opacity: 0.6; }
      91% { opacity: 0.1; }
    }
  </style>
</head>
<body>
  <!-- Digital static overlay -->
  <div class="digital-static"></div>

  <!-- Back button -->
  <a href="layer-3.html" class="back-link">← Phantom Palace</a>
  
  <div class="container">
    <div class="header">
      <h1 class="title">LAYER IV</h1>
      <p class="subtitle">TIME LABORATORY</p>
      <p class="location">"The universe has a beginning, but no end. — Infinite."</p>
    </div>

    <!-- Steins;Gate Laboratory Container -->
    <div class="lab-container">
      <h3 class="lab-title">⚡ FUTURE GADGET LABORATORY ⚡</h3>
      
      <!-- Time Machine Interface -->
      <div class="time-machine">
        <div class="microwave-section">
          <h4 style="color: #00ccff; margin-bottom: 1rem; font-family: 'Orbitron', monospace;">PhoneWave (Name Subject to Change)</h4>
          <div class="microwave-container">
            <img src="../assets/steinsgate/mikrofala.png" alt="PhoneWave" class="microwave-img" id="microwave">
          </div>
          <p style="color: #ffffff; font-size: 0.9rem; font-style: italic;">Future Gadget #8</p>
        </div>
        
        <div class="banana-section">
          <h4 style="color: #00ccff; margin-bottom: 1rem; font-family: 'Orbitron', monospace;">Gel-Banana Experiment</h4>
          <div>
            <img src="../assets/steinsgate/banan.png" alt="Normal Banana" class="banana-img" id="normalBanana">
            <img src="../assets/steinsgate/greenbanan.png" alt="Gel-Banana" class="banana-img" id="gelBanana" style="display: none;">
          </div>
          <p style="color: #ffffff; font-size: 0.9rem; font-style: italic;">Subject: Banana Gelification</p>
        </div>
      </div>

      <!-- Multi-Phase Experiment System -->
      <div class="time-controls">
        <div class="experiment-status">
          <div class="phase-indicator" id="phaseIndicator">
            <span class="phase-title">PHASE 1: CALIBRATION</span>
            <div class="phase-progress">
              <div class="progress-bar" id="progressBar"></div>
            </div>
          </div>
          
          <div class="time-display" id="timeDisplay">
            Current Time: <span id="currentTime">2025-07-01 14:30:00</span>
          </div>
          
          <div class="divergence-meter" id="divergenceMeter">
            1.130205%
          </div>
          
          <div class="stability-meter" id="stabilityMeter">
            <span class="stability-label">Time Stability:</span>
            <div class="stability-bar">
              <div class="stability-fill" id="stabilityFill" style="width: 100%;"></div>
            </div>
            <span class="stability-value" id="stabilityValue">100%</span>
          </div>
        </div>

        <!-- Phase 1: Advanced Calibration -->
        <div class="calibration-panel" id="calibrationPanel">
          <h4 class="panel-title">⚙️ PHONEWAVE CALIBRATION REQUIRED</h4>
          <div class="calibration-grid">
            <div class="calibration-control fibonacci-hint">
              <label>Temperature (°C)</label>
              <input type="range" id="tempSlider" min="0" max="300" value="150" oninput="updateCalibration()">
              <span id="tempValue">150°C</span>
              <div class="target-zone ultra-glitch music-sync" data-scrambled="T∆rg3t: ⌐20°Ç ± ∮°Ç">
                T▲rg□t: 1⚡0°C ± █°C
                <div class="morse-pattern">-- --- .-. ... .</div>
                <div class="complexity-indicator"></div>
                <div class="hidden-cipher">φ × 100 - 23 = ?</div>
              </div>
              <div class="cipher-hint">ROT13: G∆e□t: ⌐⚡⌐°P ± ∮°P</div>
            </div>
            
            <div class="calibration-control prime-hint">
              <label>Power Level (%)</label>
              <input type="range" id="powerSlider" min="0" max="100" value="50" oninput="updateCalibration()">
              <span id="powerValue">50%</span>
              <div class="target-zone ultra-glitch music-sync" data-scrambled="T∆rg3t: ⌐⚡% ± █%">
                T▲rg□t: 7⚡% ± █%
                <div class="morse-pattern">-.. .- ... .... .</div>
                <div class="complexity-indicator"></div>
                <div class="hidden-cipher">72nd prime - 1 = ?</div>
              </div>
              <div class="cipher-hint">HEX: 0x48% ± 0x03%</div>
            </div>
            
            <div class="calibration-control hex-hint">
              <label>Frequency (Hz)</label>
              <input type="range" id="freqSlider" min="2400" max="2500" value="2450" oninput="updateCalibration()">
              <span id="freqValue">2450 Hz</span>
              <div class="target-zone ultra-glitch music-sync" data-scrambled="T∆rg3t: ⚡.4∮█ GHz ± 0.00⚡">
                T▲rg□t: ⚡.4∮█ GHz ± 0.00⚡
                <div class="morse-pattern">-... .. -. .- .-. -.--</div>
                <div class="complexity-indicator"></div>
                <div class="hidden-cipher">0x998₁₆ = ?₁₀</div>
              </div>
              <div class="cipher-hint">OCT: 4630Hz ± 2Hz</div>
            </div>
            
            <div class="calibration-control">
              <label>Phone Connection</label>
              <input type="text" id="phoneInput" placeholder="Enter IBN 5100 code" maxlength="8" oninput="updateCalibration()">
              <div class="target-zone ultra-glitch music-sync" data-scrambled="C0d3: $T3!N###">
                C□d□: $T△!N█##
                <div class="morse-pattern">.--. .... --- -. .</div>
                <div class="complexity-indicator"></div>
                <div class="hidden-cipher">Lab designation + random 3-digit</div>
              </div>
              <div class="cipher-hint">Base64: U1RFSU40NzM= (Phone), QTdGMkM4RTFCOUQ0 (IBM)</div>
            </div>
          </div>
          
          <div class="calibration-status" id="calibrationStatus">
            <div class="status-indicator" id="tempStatus">❌ Temperature</div>
            <div class="status-indicator" id="powerStatus">❌ Power Level</div>
            <div class="status-indicator" id="freqStatus">❌ Frequency</div>
            <div class="status-indicator" id="phoneStatus">❌ Phone Code</div>
          </div>
          
          <button class="time-btn" id="confirmCalibration" onclick="playButtonSound(); confirmCalibration()" disabled>Confirm Calibration</button>
        </div>

        <!-- Phase 2: Gel-Banana Experiment -->
        <div class="experiment-panel" id="experimentPanel" style="display: none;">
          <h4 class="panel-title">🍌 GEL-BANANA EXPERIMENT</h4>
          <div class="experiment-controls">
            <div class="experiment-timer" id="experimentTimer">
              Experiment Timer: <span id="timerValue">00:00</span>
            </div>
            
            <div class="control-buttons">
              <button class="time-btn" id="insertBanana" onclick="playButtonSound(); insertBanana()">Insert Banana</button>
              <button class="time-btn" id="activateMicrowave" onclick="playButtonSound(); activateMicrowave()" disabled>Activate PhoneWave</button>
              <button class="time-btn emergency-stop" id="emergencyStop" onclick="playButtonSound(); emergencyStop()" disabled>🚨 EMERGENCY STOP</button>
            </div>
            
            <div class="reaction-monitor" id="reactionMonitor">
              <div class="monitor-reading">Radiation: <span id="radiationLevel">0.0</span> mSv</div>
              <div class="monitor-reading">Gel Progress: <span id="gelProgress">0</span>%</div>
              <div class="monitor-reading">Anomaly Level: <span id="anomalyLevel">NORMAL</span></div>
            </div>
          </div>
        </div>

        <!-- Phase 3: D-Mail Transmission -->
        <div class="dmail-panel" id="dmailPanel" style="display: none;">
          <h4 class="panel-title">� D-MAIL TRANSMISSION SYSTEM</h4>
          <div class="dmail-controls">
            <div class="dmail-setup">
              <label>IBN 5100 Access Code:</label>
              <input type="password" id="ibmCode" placeholder="Enter 12-digit hex code" maxlength="12">
              
              <label>Message Content (max 36 chars):</label>
              <textarea id="messageContent" maxlength="36" placeholder="Enter your message to the past..." oninput="updateCharCount()"></textarea>
              <div class="char-counter"><span id="charCount">0</span>/36 characters</div>
              
              <label>SERN Network Status:</label>
              <div class="sern-status" id="sernStatus">
                <div class="sern-indicator">🔴 SERN Access: DENIED</div>
                <button class="time-btn small" id="hackSern" onclick="playButtonSound(); hackSern()">Attempt SERN Hack</button>
              </div>
            </div>
            
            <button class="time-btn" id="sendDMail" onclick="playButtonSound(); sendDMail()" disabled>Transmit D-Mail</button>
          </div>
        </div>

        <!-- Phase 4: Time Leap -->
        <div class="timeleap-panel" id="timeleapPanel" style="display: none;">
          <h4 class="panel-title">⏰ TIME LEAP MACHINE</h4>
          <div class="timeleap-controls">
            <div class="memory-compression">
              <label>Memory Compression (GB):</label>
              <div class="compression-display">
                <div class="compression-bar">
                  <div class="compression-fill" id="compressionFill" style="width: 0%;"></div>
                </div>
                <span id="compressionValue">0.0 / 2.5 GB</span>
              </div>
              <button class="time-btn small" id="compressMemory" onclick="playButtonSound(); compressMemory()">Start Compression</button>
            </div>
            
            <div class="leap-target">
              <label>Jump Target (hours):</label>
              <input type="number" id="leapHours" min="1" max="48" value="24" oninput="calculateLeapRisk()">
              <div class="leap-risk" id="leapRisk">Risk Level: MODERATE</div>
            </div>
            
            <div class="leap-precision">
              <label>Temporal Precision:</label>
              <input type="range" id="precisionSlider" min="0" max="100" value="50" oninput="updatePrecision()">
              <span id="precisionValue">50%</span>
              <div class="precision-warning">Higher precision = lower success rate</div>
            </div>
            
            <button class="time-btn" id="executeLeap" onclick="playButtonSound(); executeTimeLeap()" disabled>Execute Time Leap</button>
          </div>
        </div>
      </div>

      <!-- Experiment Log -->
      <div class="experiment-log" id="experimentLog">
        <div class="log-entry">Lab initialized. Standing by for experiments...</div>
        <div class="log-entry">Warning: Time travel experiments are extremely dangerous.</div>
        <div class="log-entry">Remember: Changing the past may alter the future irreversibly. <span class="hidden-fragment" title="Fragment found">Doq</span></div>
      </div>
    </div>
  </div>

  <!-- Victory Modal -->
  <div id="victoryModal" class="modal">
    <div class="modal-content">
      <h3>🌀 WORLD LINE SHIFTED! 🌀</h3>
      <p id="victoryText"></p>
      <button class="close-btn" onclick="playButtonSound(); continueJourney()">Continue to the Gate of Steiner</button>
    </div>
  </div>

  <!-- Audio Background -->
  <audio id="bgMusic" loop>
    <source src="../assets/steinsgate/steinsgate.mp3" type="audio/mpeg">
  </audio>
  
  <!-- Button Sound Effect -->
  <audio id="buttonSound" preload="auto">
    <source src="../assets/steinsgate/button.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Game Timers Object
    let gameTimers = {};
    
    // Complex Multi-Phase Experiment System
    let experimentState = {
      // Core state
      phase: 1, // 1: calibration, 2: experiment, 3: dmail, 4: timeleap
      divergence: 1.130205,
      timeStability: 100.0,
      failures: 0,
      maxFailures: 3,
      
      // Phase 1: Calibration
      calibration: {
        temperature: 150, // Target: 120 ± 5
        power: 50, // Target: 72 ± 3
        frequency: 2450, // Target: 2456 ± 2
        phoneCode: "", // Target: STEIN### (where ### is random 3-digit)
        isComplete: false,
        attempts: 0,
        maxAttempts: 5
      },
      
      // Phase 2: Experiment
      experiment: {
        bananaInserted: false,
        isRunning: false,
        timer: 0,
        targetTime: 90, // seconds for proper gelification
        radiation: 0.0,
        gelProgress: 0,
        anomalyLevel: "NORMAL",
        emergencyStop: false,
        perfectTiming: false
      },
      
      // Phase 3: D-Mail
      dmail: {
        ibmCode: "", // Target: random 12-digit hex
        message: "",
        sernHacked: false,
        hackAttempts: 0,
        maxHackAttempts: 3,
        transmitted: false
      },
      
      // Phase 4: Time Leap
      timeleap: {
        memoryCompressed: false,
        compressionProgress: 0.0,
        targetHours: 24,
        precision: 50,
        riskLevel: "MODERATE",
        executed: false
      }
    };

    // FIXED CODES - Always the same for consistency
    let generatedCodes = {
      phoneCode: "STEIN473", // Fixed phone code
      ibmCode: "A7F2C8E1B9D4", // Fixed 12-digit hex IBM code
      // Hidden cipher keys
      tempCipher: [120], // Real target hidden in fibonacci sequence 
      powerCipher: [72], // Real target in prime numbers
      freqCipher: [2456], // Real target in hex conversion
      secretFrequency: 2456, // The actual target
      morseHints: {
        temp: "-- --- .-. ... .", // MORSE
        power: "-.. .- ... .... .", // DASHE  
        freq: "-... .. -. .- .-. -.--", // BINARY
        phone: ".--. .... --- -. ." // PHONE
      }
    };

    // Harder decryption system
    let riddleSystem = {
      active: false,
      riddlesShown: [],
      decryptionProgress: 0,
      hintsUnlocked: 0,
      cipherSolved: {
        temperature: false,
        power: false,
        frequency: false,
        phone: false
      }
    };

    // Initialize the system with HARDER logic
    function initializeSystem() {
      updatePhaseIndicator();
      updateTime();
      updateDivergence();
      updateStability();
      
      // Start background music
      const bgMusic = document.getElementById('bgMusic');
      bgMusic.volume = 0.4;
      
      // Auto-play music (with user interaction backup)
      document.addEventListener('click', () => {
        if (bgMusic.paused) {
          bgMusic.play().catch(console.log);
        }
      }, { once: true });
      
      // Try to play immediately
      bgMusic.play().catch(() => {
        addLogEntry("🎵 Click anywhere to enable laboratory audio...", "warning");
      });
      
      // Start main timer
      gameTimers.main = setInterval(() => {
        updateTime();
        updateDivergence();
        
        // Random stability fluctuations
        if (Math.random() < 0.1) {
          fluctuateStability();
        }
        
        // Random cipher hints in log
        if (Math.random() < 0.05 && riddleSystem.hintsUnlocked < 4) {
          showCipherHint();
        }
      }, 1000);
      
      // Generate HARDER hidden messages
      generateHiddenCodes();
      
      addLogEntry("Future Gadget Laboratory #3 initialized.", "success");
      addLogEntry("⚠️ WARNING: Quantum encryption protocols active!", "warning");
      addLogEntry("🔐 Cipher analysis required for calibration targets...", "info");
      addLogEntry(`📞 Primary vector: ${generatedCodes.phoneCode}`, "info");
      addLogEntry(`💾 IBM access key: ${generatedCodes.ibmCode}`, "info");
      
      // Hide the real targets in seemingly random messages
      setTimeout(() => {
        addLogEntry("🧮 Mathematical sequence detected: [89, 144, 233, 377, 610, 987, 1597...]", "info");
        addLogEntry("🔍 Note: Φ (golden ratio) ≈ 1.618, Φ×100 = 161.8", "info");
      }, 3000);
      
      setTimeout(() => {
        addLogEntry("🔢 Prime analysis: [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73...]", "info");
        addLogEntry("⚠️ WARNING: False prime detected in sequence!", "warning");
      }, 6000);
      
      setTimeout(() => {
        addLogEntry("🔤 Hex conversion table: 2456₁₀ = 0x998₁₆ = 4630₈", "info");
        addLogEntry("🔐 Cross-reference: Binary 100110011000₂ = ?", "info");
      }, 9000);
      
      setTimeout(() => {
        addLogEntry("📡 DECOY SIGNALS DETECTED: 115°C, 68%, 2440Hz", "error");
        addLogEntry("🚨 Ignore false calibration targets!", "warning");
      }, 12000);
      
      setTimeout(() => {
        addLogEntry("🧬 DNA sequence anomaly: ATCG-STEIN-GATE pattern", "info");
        addLogEntry("🔬 Lab designation protocol confirmed", "success");
      }, 15000);
      
      console.log("🕰️ ULTRA-HARD EXPERIMENT SYSTEM LOADED");
      console.log("🔑 Hidden codes require decryption...");
    }

    // Play button sound effect
    function playButtonSound() {
      const buttonSound = document.getElementById('buttonSound');
      if (buttonSound) {
        buttonSound.currentTime = 0; // Reset to beginning
        buttonSound.volume = 0.3;
        buttonSound.play().catch(console.log);
      }
    }

    function generateHiddenCodes() {
      // Temperature: Hidden in Fibonacci sequence (120 = index where fib > 120)
      // Power: Hidden in prime numbers (72 is close to 71st prime)  
      // Frequency: Hidden in hex conversion (2456)
      
      riddleSystem.realTargets = {
        temp: 120, // 5th element after [89, 144] in fibonacci
        power: 72, // Prime number sequence hint
        freq: 2456, // Hex conversion 0x998
      };
    }

    function showCipherHint() {
      const hints = [
        "🔍 Pattern analysis: Fibonacci convergence at index Φ×100...",
        "🔍 Prime distribution anomaly near 7×10+2...",
        "🔍 Hexadecimal signatures: 0x998 = ?₁₀",
        "🔍 IBN 5100 authentication token format: [KNOWN_PREFIX][3_DIGITS]"
      ];
      
      if (riddleSystem.hintsUnlocked < hints.length) {
        addLogEntry(hints[riddleSystem.hintsUnlocked], "info");
        riddleSystem.hintsUnlocked++;
      }
    }

    // Phase management
    function updatePhaseIndicator() {
      const phaseEl = document.querySelector('.phase-title');
      const progressBar = document.getElementById('progressBar');
      
      const phases = [
        "PHASE 1: CALIBRATION",
        "PHASE 2: EXPERIMENT",
        "PHASE 3: D-MAIL",
        "PHASE 4: TIME LEAP"
      ];
      
      phaseEl.textContent = phases[experimentState.phase - 1];
      progressBar.style.width = (experimentState.phase * 25) + '%';
    }

    function nextPhase() {
      if (experimentState.phase < 4) {
        experimentState.phase++;
        updatePhaseIndicator();
        showPhasePanel();
        addLogEntry(`Phase ${experimentState.phase} unlocked!`, "success");
      }
    }

    function showPhasePanel() {
      // Hide all panels
      document.getElementById('calibrationPanel').style.display = 'none';
      document.getElementById('experimentPanel').style.display = 'none';
      document.getElementById('dmailPanel').style.display = 'none';
      document.getElementById('timeleapPanel').style.display = 'none';
      
      // Show current phase panel
      const panels = ['calibrationPanel', 'experimentPanel', 'dmailPanel', 'timeleapPanel'];
      document.getElementById(panels[experimentState.phase - 1]).style.display = 'block';
    }

    // PHASE 1: CALIBRATION SYSTEM
    function updateCalibration() {
      const temp = parseInt(document.getElementById('tempSlider').value);
      const power = parseInt(document.getElementById('powerSlider').value);
      const freq = parseInt(document.getElementById('freqSlider').value);
      const phoneCode = document.getElementById('phoneInput').value.toUpperCase();
      
      // Update display values
      document.getElementById('tempValue').textContent = temp + '°C';
      document.getElementById('powerValue').textContent = power + '%';
      document.getElementById('freqValue').textContent = freq + ' Hz';
      
      // Update calibration state
      experimentState.calibration.temperature = temp;
      experimentState.calibration.power = power;
      experimentState.calibration.frequency = freq;
      experimentState.calibration.phoneCode = phoneCode;
      
      // Check calibration targets
      checkCalibrationStatus();
    }

    function checkCalibrationStatus() {
      const cal = experimentState.calibration;
      
      // ULTRA HARD: Real targets are hidden and must be decrypted!
      const realTargets = {
        temp: 120, // Hidden in Fibonacci sequence (after 89, 144...)
        power: 72, // Hidden in prime numbers  
        freq: 2456, // Hidden in hex conversion 0x998
        phone: generatedCodes.phoneCode
      };
      
      const status = {
        temp: Math.abs(cal.temperature - realTargets.temp) <= 5,
        power: Math.abs(cal.power - realTargets.power) <= 3,
        freq: Math.abs(cal.frequency - realTargets.freq) <= 2,
        phone: cal.phoneCode === realTargets.phone
      };
      
      // Update status indicators with cipher feedback
      updateStatusIndicator('tempStatus', status.temp, cal.temperature, realTargets.temp);
      updateStatusIndicator('powerStatus', status.power, cal.power, realTargets.power);
      updateStatusIndicator('freqStatus', status.freq, cal.frequency, realTargets.freq);
      updateStatusIndicator('phoneStatus', status.phone, cal.phoneCode, realTargets.phone);
      
      // Enable confirm button if all calibrated
      const allCalibrated = Object.values(status).every(s => s);
      document.getElementById('confirmCalibration').disabled = !allCalibrated;
      
      cal.isComplete = allCalibrated;
      
      // Give cryptic hints when close
      if (!status.temp && Math.abs(cal.temperature - realTargets.temp) <= 15) {
        showCrypticHint('temp', cal.temperature, realTargets.temp);
      }
      if (!status.power && Math.abs(cal.power - realTargets.power) <= 10) {
        showCrypticHint('power', cal.power, realTargets.power);
      }
      if (!status.freq && Math.abs(cal.frequency - realTargets.freq) <= 20) {
        showCrypticHint('freq', cal.frequency, realTargets.freq);
      }
    }

    function updateStatusIndicator(id, success, current, target) {
      const el = document.getElementById(id);
      if (success) {
        el.textContent = '✅ ' + el.textContent.substring(2);
        el.classList.add('success');
      } else {
        el.textContent = '❌ ' + el.textContent.substring(2);
        el.classList.remove('success');
        
        // Show cryptic proximity hints
        const diff = Math.abs(current - target);
        if (diff <= 5) {
          el.style.color = '#ffaa00';
          el.style.animation = 'proximityPulse 1s infinite';
        } else {
          el.style.color = '#ff4444';
          el.style.animation = 'none';
        }
      }
    }

    function showCrypticHint(type, current, target) {
      const hints = {
        temp: [
          "🌡️ Thermal signature approaching Fibonacci convergence...",
          "🔥 Temperature differential: Φ ratio detected...",
          "❄️ Quantum state requires golden mean thermal alignment..."
        ],
        power: [
          "⚡ Power matrix nearing prime distribution peak...",
          "🔋 Energy resonance approaching 72nd harmonic...",
          "⭐ Quantum flux requires prime-adjacent configuration..."
        ],
        freq: [
          "📡 Frequency approaching hexadecimal signature 0x998...",
          "🔊 Harmonic convergence at binary threshold...",
          "📻 Electromagnetic resonance: hex-decimal alignment required..."
        ]
      };
      
      if (hints[type] && Math.random() < 0.3) {
        const randomHint = hints[type][Math.floor(Math.random() * hints[type].length)];
        addLogEntry(randomHint, "warning");
      }
    }

    function confirmCalibration() {
      if (experimentState.calibration.isComplete) {
        addLogEntry("PhoneWave calibration confirmed!", "success");
        addLogEntry("All parameters within acceptable ranges.", "success");
        addLogEntry("🔐 Quantum encryption protocols validated.", "success");
        addLogEntry("Proceeding to experimental phase...", "info");
        
        nextPhase();
      } else {
        experimentState.calibration.attempts++;
        
        // Show what was wrong (but cryptically)
        const cal = experimentState.calibration;
        const realTargets = { temp: 120, power: 72, freq: 2456, phone: generatedCodes.phoneCode };
        
        let errors = [];
        if (Math.abs(cal.temperature - realTargets.temp) > 5) {
          errors.push(`🌡️ Thermal: ${cal.temperature}°C (Fibonacci convergence required)`);
        }
        if (Math.abs(cal.power - realTargets.power) > 3) {
          errors.push(`⚡ Power: ${cal.power}% (Prime distribution needed)`);
        }
        if (Math.abs(cal.frequency - realTargets.freq) > 2) {
          errors.push(`📡 Freq: ${cal.frequency}Hz (Hex 0x998 conversion)`);
        }
        if (cal.phoneCode !== realTargets.phone) {
          errors.push(`📞 Auth: ${cal.phoneCode} (Lab designation protocol)`);
        }
        
        addLogEntry(`Calibration attempt ${experimentState.calibration.attempts} failed!`, "error");
        errors.forEach(error => addLogEntry(error, "warning"));
        
        // Add red herrings after failures
        if (experimentState.calibration.attempts === 2) {
          addLogEntry("💀 DECEPTION PROTOCOL: Ignore 118°C, 75%, 2458Hz", "error");
        }
        if (experimentState.calibration.attempts === 3) {
          addLogEntry("🔍 CIPHER HINT: F(n) where F(12)=144, F(13)=233...", "info");
        }
        
        if (experimentState.calibration.attempts >= experimentState.calibration.maxAttempts) {
          addLogEntry("⚠️ Maximum calibration attempts exceeded!", "error");
          addLogEntry("🚨 SECURITY PROTOCOL: System lockdown initiated!", "error");
          addLogEntry("Temporal paradox risk too high. Reloading...", "warning");
          
          setTimeout(() => {
            location.reload();
          }, 3000);
        }
      }
    }

    // PHASE 2: EXPERIMENT SYSTEM
    function insertBanana() {
      if (!experimentState.experiment.bananaInserted) {
        experimentState.experiment.bananaInserted = true;
        document.getElementById('insertBanana').disabled = true;
        document.getElementById('activateMicrowave').disabled = false;
        
        // Visual feedback
        document.getElementById('normalBanana').style.display = 'none';
        document.getElementById('gelBanana').style.display = 'inline-block';
        
        addLogEntry("Banana inserted into PhoneWave chamber.", "success");
        addLogEntry("Organic matter detected. Standing by for activation.", "info");
      }
    }

    function activateMicrowave() {
      if (!experimentState.experiment.isRunning && experimentState.experiment.bananaInserted) {
        experimentState.experiment.isRunning = true;
        experimentState.experiment.timer = 0;
        
        document.getElementById('activateMicrowave').disabled = true;
        document.getElementById('emergencyStop').disabled = false;
        
        // Start experiment timer
        gameTimers.experiment = setInterval(updateExperiment, 100);
        
        addLogEntry("PhoneWave activated! Gelification process initiated.", "warning");
        addLogEntry("⚠️ Monitoring for temporal anomalies...", "warning");
        
        // Random events during experiment
        setTimeout(() => randomExperimentEvent(), Math.random() * 30000 + 10000);
      }
    }

    function updateExperiment() {
      const exp = experimentState.experiment;
      exp.timer += 0.1;
      
      // Update displays
      const minutes = Math.floor(exp.timer / 60);
      const seconds = Math.floor(exp.timer % 60);
      document.getElementById('timerValue').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Calculate radiation based on timer
      exp.radiation = Math.min(exp.timer * 0.1, 5.0);
      document.getElementById('radiationLevel').textContent = exp.radiation.toFixed(1);
      
      // Calculate gel progress
      exp.gelProgress = Math.min((exp.timer / exp.targetTime) * 100, 100);
      document.getElementById('gelProgress').textContent = Math.floor(exp.gelProgress);
      
      // Update anomaly level
      if (exp.timer > exp.targetTime * 1.5) {
        exp.anomalyLevel = "CRITICAL";
        document.getElementById('anomalyLevel').style.color = '#ff4444';
      } else if (exp.timer > exp.targetTime) {
        exp.anomalyLevel = "HIGH";
        document.getElementById('anomalyLevel').style.color = '#ffaa00';
      } else {
        exp.anomalyLevel = "NORMAL";
        document.getElementById('anomalyLevel').style.color = '#00ff00';
      }
      document.getElementById('anomalyLevel').textContent = exp.anomalyLevel;
      
      // Check for perfect timing (85-95 seconds)
      if (exp.timer >= 85 && exp.timer <= 95 && exp.gelProgress >= 95) {
        exp.perfectTiming = true;
      }
      
      // Auto-advance if timer reaches target
      if (exp.timer >= exp.targetTime && !exp.emergencyStop) {
        emergencyStop();
        if (exp.perfectTiming) {
          addLogEntry("Perfect gelification achieved!", "success");
          nextPhase();
        } else {
          addLogEntry("Gelification complete, but timing was suboptimal.", "warning");
          nextPhase();
        }
      }
      
      // Failure if too long
      if (exp.timer > exp.targetTime * 2) {
        emergencyStop();
        addLogEntry("⚠️ EXPERIMENT FAILURE: Banana exploded!", "error");
        handleFailure();
      }
    }

    function emergencyStop() {
      if (experimentState.experiment.isRunning) {
        experimentState.experiment.isRunning = false;
        experimentState.experiment.emergencyStop = true;
        
        clearInterval(gameTimers.experiment);
        
        document.getElementById('emergencyStop').disabled = true;
        document.getElementById('activateMicrowave').disabled = true;
        
        addLogEntry("Emergency stop activated! Experiment terminated.", "warning");
        
        if (experimentState.experiment.gelProgress >= 95) {
          addLogEntry("Gelification process completed successfully.", "success");
          nextPhase();
        } else {
          addLogEntry("Incomplete gelification. Experiment failed.", "error");
          handleFailure();
        }
      }
    }

    function randomExperimentEvent() {
      if (experimentState.experiment.isRunning) {
        const events = [
          () => {
            addLogEntry("⚠️ Temporal fluctuation detected!", "warning");
            experimentState.timeStability -= 10;
            updateStability();
          },
          () => {
            addLogEntry("💥 Micro-explosion in chamber!", "error");
            experimentState.experiment.radiation += 1.0;
          },
          () => {
            addLogEntry("🌀 Wormhole signature detected!", "info");
            experimentState.divergence += 0.000123;
            updateDivergence();
          }
        ];
        
        const randomEvent = events[Math.floor(Math.random() * events.length)];
        randomEvent();
      }
    }

    // PHASE 3: D-MAIL SYSTEM
    function updateCharCount() {
      const message = document.getElementById('messageContent').value;
      document.getElementById('charCount').textContent = message.length;
      
      experimentState.dmail.message = message;
      updateDMailStatus();
    }

    function hackSern() {
      experimentState.dmail.hackAttempts++;
      
      addLogEntry(`SERN hack attempt ${experimentState.dmail.hackAttempts}/3...`, "warning");
      
      // Random success chance (harder each attempt)
      const successChance = 0.7 - (experimentState.dmail.hackAttempts - 1) * 0.2;
      
      setTimeout(() => {
        if (Math.random() < successChance) {
          experimentState.dmail.sernHacked = true;
          document.getElementById('sernStatus').classList.add('hacked');
          document.querySelector('.sern-indicator').textContent = '🟢 SERN Access: GRANTED';
          document.getElementById('hackSern').disabled = true;
          
          addLogEntry("SERN database compromised successfully!", "success");
          addLogEntry(`IBM Code required: ${generatedCodes.ibmCode}`, "info");
          updateDMailStatus();
        } else {
          addLogEntry("SERN hack failed! Firewall detected intrusion.", "error");
          
          if (experimentState.dmail.hackAttempts >= experimentState.dmail.maxHackAttempts) {
            addLogEntry("⚠️ SERN security lockdown initiated!", "error");
            document.getElementById('hackSern').disabled = true;
            handleFailure();
          }
        }
      }, 2000 + Math.random() * 3000);
    }

    function updateDMailStatus() {
      const ibmCode = document.getElementById('ibmCode').value.toUpperCase();
      const message = experimentState.dmail.message;
      
      const validCode = ibmCode === generatedCodes.ibmCode;
      const validMessage = message.length > 10 && message.length <= 36;
      const sernAccess = experimentState.dmail.sernHacked;
      
      document.getElementById('sendDMail').disabled = !(validCode && validMessage && sernAccess);
    }

    function sendDMail() {
      const ibmCode = document.getElementById('ibmCode').value.toUpperCase();
      
      if (ibmCode === generatedCodes.ibmCode && experimentState.dmail.sernHacked) {
        experimentState.dmail.transmitted = true;
        
        addLogEntry("D-Mail transmission initiated...", "warning");
        addLogEntry(`Message: "${experimentState.dmail.message}"`, "info");
        
        setTimeout(() => {
          addLogEntry("D-Mail successfully transmitted to the past!", "success");
          addLogEntry("⚠️ Timeline alteration detected!", "warning");
          
          experimentState.divergence += 0.025891;
          updateDivergence();
          
          addLogEntry("World line shift confirmed! Proceeding to final phase...", "success");
          nextPhase();
        }, 3000);
      } else {
        addLogEntry("Invalid IBN 5100 code! Transmission failed.", "error");
        handleFailure();
      }
    }

    // PHASE 4: TIME LEAP SYSTEM
    function compressMemory() {
      if (!experimentState.timeleap.memoryCompressed) {
        experimentState.timeleap.compressionProgress = 0;
        
        addLogEntry("Memory compression initiated...", "warning");
        addLogEntry("Compressing 2.5GB of temporal data...", "info");
        
        gameTimers.compression = setInterval(() => {
          experimentState.timeleap.compressionProgress += 2.5; // 2.5% per interval
          
          document.getElementById('compressionFill').style.width = experimentState.timeleap.compressionProgress + '%';
          document.getElementById('compressionValue').textContent = 
            `${(experimentState.timeleap.compressionProgress * 2.5 / 100).toFixed(1)} / 2.5 GB`;
          
          if (experimentState.timeleap.compressionProgress >= 100) {
            clearInterval(gameTimers.compression);
            experimentState.timeleap.memoryCompressed = true;
            
            addLogEntry("Memory compression complete!", "success");
            document.getElementById('compressMemory').disabled = true;
            document.getElementById('executeLeap').disabled = false;
          }
        }, 200);
      }
    }

    function calculateLeapRisk() {
      const hours = parseInt(document.getElementById('leapHours').value);
      experimentState.timeleap.targetHours = hours;
      
      let risk = "LOW";
      if (hours > 12) risk = "MODERATE";
      if (hours > 24) risk = "HIGH";
      if (hours > 36) risk = "EXTREME";
      
      experimentState.timeleap.riskLevel = risk;
      document.getElementById('leapRisk').textContent = `Risk Level: ${risk}`;
      
      // Update risk color
      const colors = { LOW: '#00ff00', MODERATE: '#ffaa00', HIGH: '#ff6600', EXTREME: '#ff4444' };
      document.getElementById('leapRisk').style.color = colors[risk];
    }

    function updatePrecision() {
      const precision = parseInt(document.getElementById('precisionSlider').value);
      experimentState.timeleap.precision = precision;
      document.getElementById('precisionValue').textContent = precision + '%';
    }

    function executeTimeLeap() {
      if (experimentState.timeleap.memoryCompressed) {
        addLogEntry("Time Leap sequence initiated!", "warning");
        addLogEntry("⚠️ Consciousness transfer in progress...", "error");
        
        // Calculate success chance based on risk and precision
        const riskPenalty = { LOW: 0, MODERATE: 0.1, HIGH: 0.3, EXTREME: 0.5 };
        const precisionPenalty = experimentState.timeleap.precision / 200; // Higher precision = higher penalty
        const successChance = 0.8 - riskPenalty[experimentState.timeleap.riskLevel] - precisionPenalty;
        
        setTimeout(() => {
          if (Math.random() < successChance) {
            // Success!
            addLogEntry("Time Leap successful!", "success");
            addLogEntry(`Jumped ${experimentState.timeleap.targetHours} hours into the past!`, "success");
            
            experimentState.divergence = 1.571024;
            updateDivergence();
            
            // Victory sequence
            setTimeout(() => {
              showVictory();
            }, 2000);
          } else {
            // Failure!
            addLogEntry("⚠️ TIME LEAP FAILED!", "error");
            addLogEntry("Consciousness fragmentation detected!", "error");
            addLogEntry("Memory corruption in progress...", "error");
            
            handleCriticalFailure();
          }
        }, 5000);
      }
    }

    // Utility functions
    function updateTime() {
      const now = new Date();
      const timeString = now.toISOString().slice(0, 19).replace('T', ' ');
      document.getElementById('currentTime').textContent = timeString;
    }

    function updateDivergence() {
      document.getElementById('divergenceMeter').textContent = experimentState.divergence.toFixed(6) + '%';
    }

    function updateStability() {
      document.getElementById('stabilityFill').style.width = experimentState.timeStability + '%';
      document.getElementById('stabilityValue').textContent = Math.floor(experimentState.timeStability) + '%';
      
      if (experimentState.timeStability < 50) {
        document.getElementById('stabilityFill').style.background = 'linear-gradient(90deg, #ff4444, #ffaa00)';
      } else if (experimentState.timeStability < 80) {
        document.getElementById('stabilityFill').style.background = 'linear-gradient(90deg, #ffaa00, #00ff00)';
      } else {
        document.getElementById('stabilityFill').style.background = 'linear-gradient(90deg, #00ff00, #00ccff)';
      }
    }

    function fluctuateStability() {
      const change = (Math.random() - 0.5) * 5;
      experimentState.timeStability = Math.max(0, Math.min(100, experimentState.timeStability + change));
      updateStability();
    }

    function addLogEntry(message, type = 'normal') {
      const log = document.getElementById('experimentLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function handleFailure() {
      experimentState.failures++;
      
      if (experimentState.failures >= experimentState.maxFailures) {
        addLogEntry("⚠️ CRITICAL SYSTEM FAILURE!", "error");
        addLogEntry("Too many failed attempts. Laboratory lockdown initiated.", "error");
        
        setTimeout(() => {
          alert("SYSTEM FAILURE\n\nToo many failed experiments!\nReturning to previous layer...");
          window.location.href = 'layer-3.html';
        }, 3000);
      } else {
        addLogEntry(`Failure ${experimentState.failures}/${experimentState.maxFailures}. Be more careful!`, "warning");
        
        // Reset current phase
        if (experimentState.phase === 2) {
          resetExperiment();
        }
      }
    }

    function handleCriticalFailure() {
      addLogEntry("💀 CRITICAL TIMELINE FRACTURE!", "error");
      addLogEntry("Reality collapse imminent...", "error");
      
      setTimeout(() => {
        alert("💀 TIME PARADOX DETECTED 💀\n\nYour reckless experimentation has caused a critical timeline fracture!\n\nReturning to a safer reality...");
        window.location.href = 'layer-3.html';
      }, 4000);
    }

    function resetExperiment() {
      experimentState.experiment = {
        bananaInserted: false,
        isRunning: false,
        timer: 0,
        targetTime: 90,
        radiation: 0.0,
        gelProgress: 0,
        anomalyLevel: "NORMAL",
        emergencyStop: false,
        perfectTiming: false
      };
      
      // Reset UI
      document.getElementById('normalBanana').style.display = 'inline-block';
      document.getElementById('gelBanana').style.display = 'none';
      document.getElementById('insertBanana').disabled = false;
      document.getElementById('activateMicrowave').disabled = true;
      document.getElementById('emergencyStop').disabled = true;
      
      clearInterval(gameTimers.experiment);
    }

    function showVictory() {
      const modal = document.getElementById('victoryModal');
      const victoryText = document.getElementById('victoryText');
      
      victoryText.innerHTML = `
        <strong>🌀 CONGRATULATIONS, LAB MEMBER! 🌀</strong><br><br>
        You have successfully navigated the treacherous waters of time travel experimentation!<br><br>
        <strong>Final Results:</strong><br>
        • PhoneWave Calibration: ✅ Complete<br>
        • Gel-Banana Experiment: ✅ ${experimentState.experiment.perfectTiming ? 'Perfect' : 'Successful'}<br>
        • D-Mail Transmission: ✅ Successful<br>
        • Time Leap Execution: ✅ Successful<br><br>
        <strong>Final World Line:</strong> α 1.571024%<br>
        <strong>Experiments Completed:</strong> ${4 - experimentState.failures} of 4<br>
        <strong>System Failures:</strong> ${experimentState.failures}<br><br>
        <em>The choice of Steins Gate is within reach...</em><br><br>
        <strong>El Psy Kongroo!</strong> 🕰️
      `;
      
      modal.style.display = 'block';
    }

    function continueJourney() {
      // Redirect to Layer 5 - The Gate
      window.location.href = 'layer-5.html';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', initializeSystem);
    
    // Modal controls
    window.onclick = function(event) {
      const modal = document.getElementById('victoryModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        document.getElementById('victoryModal').style.display = 'none';
      }
    });

    console.log('🕰️ ADVANCED TIME LABORATORY INITIALIZED');
    console.log('⚡ El Psy Kongroo!');
    console.log('🌀 The choice of Steins Gate awaits...');
  </script>
</body>
</html>
